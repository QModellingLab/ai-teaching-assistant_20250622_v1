{% extends "base_profile.html" %}

{% block title %}{{ student.name }} - å­¸ç¿’æª”æ¡ˆ | EMIæ™ºèƒ½æ•™å­¸åŠ©ç†{% endblock %}

{% block page_title %}ğŸ‘¤ {{ student.name }} - å€‹äººå­¸ç¿’æª”æ¡ˆ{% endblock %}
{% block page_subtitle %}Personal Learning Profile - å®Œæ•´å­¸ç¿’æ­·ç¨‹èˆ‡å³æ™‚åˆ†æ{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <a href="/">ğŸ  é¦–é </a>
    <span>â€º</span>
    <a href="/admin">âš™ï¸ ç®¡ç†å¾Œå°</a>
    <span>â€º</span>
    <a href="/students">ğŸ‘¥ å­¸ç”Ÿåˆ—è¡¨</a>
    <span>â€º</span>
    <span>ğŸ‘¤ {{ student.name }}</span>
</nav>
{% endblock %}

{% block nav_buttons %}
<a href="/students" class="btn btn-secondary">â† è¿”å›åˆ—è¡¨</a>
<a href="/students/{{ student.id }}/export" class="btn btn-export">ğŸ’¾ åŒ¯å‡ºæª”æ¡ˆ</a>
<a href="#messages" class="btn btn-primary">ğŸ’¬ æŸ¥çœ‹å°è©±</a>
<button onclick="refreshSummary()" class="btn btn-success">ğŸ”„ é‡æ–°åˆ†æ</button>
{% endblock %}

{% block stats_section %}
<div class="stats-grid">
    <div class="stat-card blue">
        <h3>{{ learning_summary.message_count }}</h3>
        <p>ğŸ’¬ ç¸½å°è©±æ•¸</p>
    </div>
    <div class="stat-card green">
        <h3>{{ learning_summary.question_count }}</h3>
        <p>â“ æå•æ¬¡æ•¸</p>
    </div>
    <div class="stat-card orange">
        <h3>{{ "%.1f"|format(student.participation_rate) }}%</h3>
        <p>ğŸ“ˆ åƒèˆ‡åº¦</p>
    </div>
    <div class="stat-card purple">
        <h3>{{ learning_summary.topics|length }}</h3>
        <p>ğŸ¯ æ¶µè“‹ä¸»é¡Œ</p>
    </div>
</div>
{% endblock %}

{% block main_content %}
<!-- å­¸ç”ŸåŸºæœ¬è³‡è¨Š -->
<div class="content-section">
    <h2 class="section-title">
        ğŸ“‹ åŸºæœ¬è³‡è¨Š
        <span style="font-size: 0.7em; color: #7f8c8d; font-weight: normal;">
            è¨»å†Šæ–¼ {{ student.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥') }}
        </span>
    </h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <!-- å€‹äººè³‡æ–™ -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #3498db;">
            <h4 style="color: #2c3e50; margin-bottom: 15px;">ğŸ‘¤ å€‹äººè³‡æ–™</h4>
            <div style="space-y: 8px;">
                <p><strong>å§“å:</strong> {{ student.name }}</p>
                <p><strong>LINE ID:</strong> <code style="background: #e9ecef; padding: 2px 6px; border-radius: 4px;">{{ student.line_user_id }}</code></p>
                {% if student.student_id %}
                <p><strong>å­¸è™Ÿ:</strong> {{ student.student_id }}</p>
                {% endif %}
                {% if student.email %}
                <p><strong>é›»å­éƒµä»¶:</strong> {{ student.email }}</p>
                {% endif %}
            </div>
        </div>

        <!-- å­¸ç¿’åå¥½ -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #e74c3c;">
            <h4 style="color: #2c3e50; margin-bottom: 15px;">ğŸ¨ å­¸ç¿’åå¥½</h4>
            <div>
                <p><strong>èªè¨€åå¥½:</strong> 
                <span class="status-tag {{ 'status-active' if student.language_preference == 'english' else 'status-moderate' if student.language_preference == 'chinese' else 'status-inactive' }}">
                    {% if student.language_preference == 'english' %}ğŸ‡ºğŸ‡¸ è‹±æ–‡ç‚ºä¸»
                    {% elif student.language_preference == 'chinese' %}ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ç‚ºä¸»
                    {% else %}ğŸŒ ä¸­è‹±æ··åˆ{% endif %}
                </span>
                </p>
                
                {% if student.learning_style %}
                <p style="margin-top: 8px;"><strong>å­¸ç¿’é¢¨æ ¼:</strong> {{ student.learning_style }}</p>
                {% endif %}
                
                {% if student.interest_areas %}
                <p style="margin-top: 8px;"><strong>èˆˆè¶£é ˜åŸŸ:</strong></p>
                <div style="margin-top: 5px;">{{ student.interest_areas[:100] }}{% if student.interest_areas|length > 100 %}...{% endif %}</div>
                {% endif %}
            </div>
        </div>

        <!-- æ´»å‹•ç‹€æ…‹ -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #27ae60;">
            <h4 style="color: #2c3e50; margin-bottom: 15px;">ğŸ“Š æ´»å‹•ç‹€æ…‹</h4>
            <div>
                {% if student.last_active %}
                <p><strong>æœ€å¾Œæ´»å‹•:</strong><br>
                   <span style="color: #27ae60;">{{ student.last_active.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}</span>
                </p>
                <p style="margin-top: 8px;"><strong>æ´»å‹•é–“éš”:</strong> 
                {% set days_ago = (now() - student.last_active).days %}
                {% if days_ago == 0 %}ä»Šå¤©
                {% elif days_ago == 1 %}1å¤©å‰
                {% elif days_ago < 7 %}{{ days_ago }}å¤©å‰
                {% elif days_ago < 30 %}{{ (days_ago/7)|round }}é€±å‰
                {% else %}{{ (days_ago/30)|round }}å€‹æœˆå‰
                {% endif %}
                </p>
                {% else %}
                <p style="color: #e74c3c;">å°šæœªé–‹å§‹æ´»å‹•</p>
                {% endif %}
                
                <p style="margin-top: 8px;"><strong>ç‹€æ…‹:</strong> 
                <span class="status-tag {{ 'status-active' if student.is_active else 'status-inactive' }}">
                    {{ 'æ´»èº' if student.is_active else 'ä¸æ´»èº' }}
                </span>
                </p>
            </div>
        </div>

        <!-- çµ±è¨ˆæ‘˜è¦ -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #f39c12;">
            <h4 style="color: #2c3e50; margin-bottom: 15px;">ğŸ“ˆ å­¸ç¿’çµ±è¨ˆ</h4>
            <div>
                <p><strong>è¨»å†Šå¤©æ•¸:</strong> {{ (now() - student.created_at).days + 1 }} å¤©</p>
                <p style="margin-top: 8px;"><strong>å¹³å‡æ¯æ—¥å°è©±:</strong> {{ "%.1f"|format(learning_summary.message_count / ((now() - student.created_at).days + 1)) }} æ¢</p>
                {% if learning_summary.question_count > 0 %}
                <p style="margin-top: 8px;"><strong>æå•æ¯”ä¾‹:</strong> {{ "%.1f"|format(learning_summary.question_count / learning_summary.message_count * 100) }}%</p>
                {% endif %}
                <p style="margin-top: 8px;"><strong>å­¸ç¿’æ´»èºåº¦:</strong> 
                {% if student.participation_rate > 80 %}
                <span style="color: #27ae60; font-weight: bold;">éå¸¸æ´»èº</span>
                {% elif student.participation_rate > 50 %}
                <span style="color: #f39c12; font-weight: bold;">é©åº¦æ´»èº</span>
                {% elif student.participation_rate > 20 %}
                <span style="color: #e67e22; font-weight: bold;">è¼•åº¦åƒèˆ‡</span>
                {% else %}
                <span style="color: #e74c3c; font-weight: bold;">éœ€è¦é¼“å‹µ</span>
                {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- å³æ™‚å­¸ç¿’æ‘˜è¦ -->
<div class="content-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <h2 class="section-title" style="color: white; border-bottom-color: rgba(255,255,255,0.3);">
        ğŸ§  AIå­¸ç¿’æ‘˜è¦åˆ†æ
        <span style="font-size: 0.7em; font-weight: normal; opacity: 0.8;">
            {{ learning_summary.summary_type }} | {{ learning_summary.actual_length }}/{{ learning_summary.target_length }}å­— | å³æ™‚ç”Ÿæˆ
        </span>
    </h2>
    
    <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 12px; backdrop-filter: blur(10px);">
        <div style="font-size: 1.1em; line-height: 1.8; margin-bottom: 20px;">
            {{ learning_summary.summary }}
        </div>
        
        {% if learning_summary.topics %}
        <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 12px; opacity: 0.9;">ğŸ¯ ä¸»è¦å­¸ç¿’ä¸»é¡Œï¼š</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                {% for topic in learning_summary.topics %}
                <span style="background: rgba(255,255,255,0.2); padding: 6px 15px; border-radius: 20px; font-size: 0.9em; backdrop-filter: blur(5px);">
                    {{ topic }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div style="display: flex; justify-content: space-between; align-items: center; opacity: 0.8; font-size: 0.85em;">
            <span>ğŸ“Š åŸºæ–¼ {{ learning_summary.message_count }} æ¢å°è©±è¨˜éŒ„åˆ†æ</span>
            <span>ğŸ•’ {{ learning_summary.generated_at[:19].replace('T', ' ') }}</span>
        </div>
    </div>
</div>

<!-- å­¸ç¿’é€²åº¦è¦–è¦ºåŒ– -->
<div class="content-section">
    <h2 class="section-title">ğŸ“ˆ å­¸ç¿’é€²åº¦åˆ†æ</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <!-- åƒèˆ‡åº¦é€²åº¦æ¢ -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h4 style="margin-bottom: 15px; color: #2c3e50;">ğŸ¯ åƒèˆ‡åº¦æŒ‡æ¨™</h4>
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>æ•´é«”åƒèˆ‡åº¦</span>
                    <span style="font-weight: bold; color: #3498db;">{{ "%.1f"|format(student.participation_rate) }}%</span>
                </div>
                <div style="background: #e9ecef; height: 8px; border-radius: 4px; margin-top: 5px;">
                    <div style="background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; width: {{ student.participation_rate }}%; border-radius: 4px; transition: width 0.5s ease;"></div>
                </div>
            </div>
            
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>æå•ç©æ¥µåº¦</span>
                    {% set question_rate = (learning_summary.question_count / learning_summary.message_count * 100) if learning_summary.message_count > 0 else 0 %}
                    <span style="font-weight: bold; color: #e74c3c;">{{ "%.1f"|format(question_rate) }}%</span>
                </div>
                <div style="background: #e9ecef; height: 8px; border-radius: 4px; margin-top: 5px;">
                    <div style="background: linear-gradient(90deg, #e74c3c, #f39c12); height: 100%; width: {{ question_rate }}%; border-radius: 4px; transition: width 0.5s ease;"></div>
                </div>
            </div>
            
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>æŒçºŒæ€§</span>
                    {% set consistency = min(100, (learning_summary.message_count / ((now() - student.created_at).days + 1)) * 20) %}
                    <span style="font-weight: bold; color: #9b59b6;">{{ "%.1f"|format(consistency) }}%</span>
                </div>
                <div style="background: #e9ecef; height: 8px; border-radius: 4px; margin-top: 5px;">
                    <div style="background: linear-gradient(90deg, #9b59b6, #e91e63); height: 100%; width: {{ consistency }}%; border-radius: 4px; transition: width 0.5s ease;"></div>
                </div>
            </div>
        </div>

        <!-- å­¸ç¿’ç‰¹å¾µé›·é”åœ– (ç°¡åŒ–ç‰ˆ) -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h4 style="margin-bottom: 15px; color: #2c3e50;">ğŸ¨ å­¸ç¿’ç‰¹å¾µåˆ†æ</h4>
            
            {% set engagement_score = min(100, student.participation_rate) %}
            {% set curiosity_score = min(100, question_rate * 2) %}
            {% set consistency_score = min(100, consistency) %}
            {% set topic_diversity = min(100, learning_summary.topics|length * 20) %}
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">
                        {% if engagement_score > 80 %}ğŸ”¥
                        {% elif engagement_score > 60 %}ğŸŒŸ
                        {% elif engagement_score > 40 %}ğŸ’«
                        {% else %}ğŸŒ±
                        {% endif %}
                    </div>
                    <div style="font-size: 0.9em; color: #7f8c8d;">åƒèˆ‡ç†±å¿±</div>
                    <div style="font-weight: bold; color: #3498db;">{{ "%.0f"|format(engagement_score) }}åˆ†</div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">
                        {% if curiosity_score > 80 %}ğŸ¤”
                        {% elif curiosity_score > 60 %}â“
                        {% elif curiosity_score > 40 %}ğŸ’­
                        {% else %}ğŸ˜¶
                        {% endif %}
                    </div>
                    <div style="font-size: 0.9em; color: #7f8c8d;">æ±‚çŸ¥æ…¾</div>
                    <div style="font-weight: bold; color: #e74c3c;">{{ "%.0f"|format(curiosity_score) }}åˆ†</div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">
                        {% if consistency_score > 80 %}âš¡
                        {% elif consistency_score > 60 %}ğŸ”„
                        {% elif consistency_score > 40 %}ğŸ“ˆ
                        {% else %}ğŸŒ
                        {% endif %}
                    </div>
                    <div style="font-size: 0.9em; color: #7f8c8d;">å­¸ç¿’é »ç‡</div>
                    <div style="font-weight: bold; color: #9b59b6;">{{ "%.0f"|format(consistency_score) }}åˆ†</div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">
                        {% if topic_diversity > 80 %}ğŸŒˆ
                        {% elif topic_diversity > 60 %}ğŸ¯
                        {% elif topic_diversity > 40 %}ğŸ“š
                        {% else %}ğŸ“–
                        {% endif %}
                    </div>
                    <div style="font-size: 0.9em; color: #7f8c8d;">ä¸»é¡Œå»£åº¦</div>
                    <div style="font-weight: bold; color: #f39c12;">{{ "%.0f"|format(topic_diversity) }}åˆ†</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å°è©±è¨˜éŒ„å€åŸŸ -->
<div class="content-section" id="messages">
    <h2 class="section-title">
        ğŸ’¬ å°è©±è¨˜éŒ„
        <span style="font-size: 0.7em; color: #7f8c8d; font-weight: normal;">
            æœ€è¿‘ {{ messages|length }} æ¢å°è©± | æ”¯æ´8æ¬¡è¨˜æ†¶AIå›æ‡‰
        </span>
    </h2>
    
    {% if messages %}
    <div class="message-list">
        {% for message in messages %}
        <div class="message-item {{ 'message-question' if message.message_type == 'question' or '?' in message.content }}">
            <div class="message-timestamp">
                <span>ğŸ•’ {{ message.timestamp.strftime('%mæœˆ%dæ—¥ %H:%M') }}</span>
                {% if message.message_type == 'question' or '?' in message.content %}
                <span style="background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                    â“ å•é¡Œ
                </span>
                {% else %}
                <span style="background: #cce5ff; color: #004085; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                    ğŸ’¬ é™³è¿°
                </span>
                {% endif %}
                
                {% if message.topic_category %}
                <span style="background: #f0f0f0; color: #666; padding: 2px 8px; border-radius: 12px; font-size: 0.75em;">
                    ğŸ·ï¸ {{ message.topic_category }}
                </span>
                {% endif %}
            </div>
            
            <div class="message-content">
                {{ message.content }}
            </div>
            
            {% if message.sentiment or message.complexity_score %}
            <div style="margin-top: 8px; font-size: 0.8em; color: #7f8c8d; display: flex; gap: 15px;">
                {% if message.sentiment %}
                <span>ğŸ˜Š æƒ…æ„Ÿ: {{ message.sentiment }}</span>
                {% endif %}
                {% if message.complexity_score %}
                <span>ğŸ§  è¤‡é›œåº¦: {{ "%.1f"|format(message.complexity_score) }}</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    {% if messages|length >= 50 %}
    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <p style="color: #7f8c8d; margin-bottom: 10px;">
            ğŸ“‹ é¡¯ç¤ºæœ€è¿‘50æ¢å°è©±è¨˜éŒ„ï¼Œå®Œæ•´è¨˜éŒ„è«‹åŒ¯å‡ºæª”æ¡ˆæŸ¥çœ‹
        </p>
        <a href="/students/{{ student.id }}/export" class="btn btn-primary">
            ğŸ’¾ åŒ¯å‡ºå®Œæ•´å°è©±è¨˜éŒ„
        </a>
    </div>
    {% endif %}
    
    {% else %}
    <div class="empty-state">
        <h3>ğŸ’¬ å°šç„¡å°è©±è¨˜éŒ„</h3>
        <p>é€™ä½å­¸ç”Ÿé‚„æ²’æœ‰é–‹å§‹èˆ‡AIåŠ©ç†çš„å°è©±ã€‚</p>
        <p style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d;">
            å­¸ç”Ÿå¯ä»¥é€éLINE Botç™¼é€è¨Šæ¯é–‹å§‹å­¸ç¿’å°è©±ã€‚
        </p>
    </div>
    {% endif %}
</div>

<!-- æ•™å­¸å»ºè­°å€åŸŸ -->
<div class="content-section" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #2c3e50;">
    <h2 class="section-title" style="color: #2c3e50; border-bottom-color: rgba(44,62,80,0.3);">
        ğŸ’¡ å€‹äººåŒ–æ•™å­¸å»ºè­°
    </h2>
    
    <div style="background: rgba(255,255,255,0.8); padding: 25px; border-radius: 12px; backdrop-filter: blur(10px);">
        {% if student.participation_rate > 80 %}
        <div style="margin-bottom: 20px;">
            <h4 style="color: #27ae60; margin-bottom: 10px;">ğŸŒŸ å„ªç§€è¡¨ç¾</h4>
            <p>{{ student.name }} å±•ç¾å‡ºè‰²çš„å­¸ç¿’åƒèˆ‡åº¦ï¼å»ºè­°ï¼š</p>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li>æä¾›æ›´å…·æŒ‘æˆ°æ€§çš„é€²éšä¸»é¡Œè¨è«–</li>
                <li>é¼“å‹µåŒå„•æŒ‡å°å’ŒçŸ¥è­˜åˆ†äº«</li>
                <li>å¢åŠ è·¨æ–‡åŒ–äº¤æµæ©Ÿæœƒ</li>
            </ul>
        </div>
        {% elif student.participation_rate > 50 %}
        <div style="margin-bottom: 20px;">
            <h4 style="color: #f39c12; margin-bottom: 10px;">ğŸ“ˆ ç©©å®šç™¼å±•</h4>
            <p>{{ student.name }} ä¿æŒè‰¯å¥½çš„å­¸ç¿’ç¯€å¥ã€‚å»ºè­°ï¼š</p>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li>å®šæœŸé¼“å‹µå’Œæ­£é¢å›é¥‹</li>
                <li>æä¾›å¤šæ¨£åŒ–çš„å­¸ç¿’è©±é¡Œ</li>
                <li>é©åº¦å¢åŠ äº’å‹•é »ç‡</li>
            </ul>
        </div>
        {% else %}
        <div style="margin-bottom: 20px;">
            <h4 style="color: #e74c3c; margin-bottom: 10px;">ğŸ¯ éœ€è¦é—œæ³¨</h4>
            <p>{{ student.name }} å¯èƒ½éœ€è¦é¡å¤–çš„å­¸ç¿’æ”¯æ´ã€‚å»ºè­°ï¼š</p>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li>ä¸»å‹•é—œæ‡·ä¸¦äº†è§£å­¸ç¿’å›°é›£</li>
                <li>æä¾›åŸºç¤å‹å–„çš„å­¸ç¿’ææ–™</li>
                <li>å»ºç«‹å®šæœŸcheck-inæ©Ÿåˆ¶</li>
            </ul>
        </div>
        {% endif %}
        
        {% if learning_summary.topics|length > 3 %}
        <div style="margin-bottom: 20px;">
            <h4 style="color: #3498db; margin-bottom: 10px;">ğŸ¨ å¤šå…ƒèˆˆè¶£</h4>
            <p>å­¸ç”Ÿå±•ç¾å°å¤šå€‹ä¸»é¡Œçš„èˆˆè¶£ï¼Œå»ºè­°æ•´åˆè·¨é ˜åŸŸå­¸ç¿’æ–¹æ¡ˆã€‚</p>
        </div>
        {% endif %}
        
        {% if question_rate > 40 %}
        <div>
            <h4 style="color: #9b59b6; margin-bottom: 10px;">ğŸ¤” ç©æ¥µæå•è€…</h4>
            <p>é«˜æå•ç‡é¡¯ç¤ºå¼·çƒˆæ±‚çŸ¥æ…¾ï¼Œå»ºè­°æä¾›æ·±åº¦è§£ç­”å’Œå»¶ä¼¸é–±è®€ææ–™ã€‚</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* å­¸ç”Ÿè©³æƒ…é å°ˆç”¨æ¨£å¼ */
    .progress-ring {
        transform: rotate(-90deg);
    }
    
    .progress-ring__circle {
        transition: stroke-dasharray 0.35s;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
    
    /* å‹•ç•«æ•ˆæœ */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .content-section {
        animation: fadeInUp 0.6s ease-out;
        animation-fill-mode: both;
    }
    
    .content-section:nth-child(1) { animation-delay: 0.1s; }
    .content-section:nth-child(2) { animation-delay: 0.2s; }
    .content-section:nth-child(3) { animation-delay: 0.3s; }
    .content-section:nth-child(4) { animation-delay: 0.4s; }
    .content-section:nth-child(5) { animation-delay: 0.5s; }
    
    /* é€²åº¦æ¢å‹•ç•« */
    .progress-bar {
        animation: expandWidth 1s ease-out 0.5s both;
    }
    
    @keyframes expandWidth {
        from { width: 0%; }
    }
    
    /* è¨Šæ¯é …ç›®æ‡¸åœæ•ˆæœ */
    .message-item {
        position: relative;
        overflow: hidden;
    }
    
    .message-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.5s ease;
    }
    
    .message-item:hover::before {
        left: 100%;
    }
    
    /* éŸ¿æ‡‰å¼å„ªåŒ– */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .nav-buttons {
            flex-direction: column;
            width: 100%;
        }
        
        .nav-buttons .btn {
            width: 100%;
            margin: 5px 0;
        }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* åˆ—å°æ¨£å¼ */
    @media print {
        .nav-buttons, #messages .message-list {
            display: none;
        }
        
        .content-section {
            break-inside: avoid;
            page-break-inside: avoid;
        }
        
        .message-item {
            break-inside: avoid;
            page-break-inside: avoid;
            margin-bottom: 5px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // å­¸ç”Ÿè©³æƒ…é å°ˆç”¨JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–é é¢å‹•ç•«
        initPageAnimations();
        
        // è¨­ç½®é€²åº¦æ¢å‹•ç•«
        animateProgressBars();
        
        // æ·»åŠ å¹³æ»‘æ»¾å‹•
        setupSmoothScrolling();
        
        // åˆå§‹åŒ–å·¥å…·æç¤º
        initTooltips();
        
        // è¨­ç½®è‡ªå‹•åˆ·æ–°æç¤º
        setupAutoRefresh();
    });

    // é é¢å‹•ç•«åˆå§‹åŒ–
    function initPageAnimations() {
        // çµ±è¨ˆå¡ç‰‡æ•¸å­—å‹•ç•«
        const statNumbers = document.querySelectorAll('.stat-card h3');
        statNumbers.forEach((element, index) => {
            const finalValue = parseInt(element.textContent) || parseFloat(element.textContent) || 0;
            element.textContent = '0';
            
            setTimeout(() => {
                animateNumber(element, 0, finalValue, 1000);
            }, index * 200);
        });
        
        // è¨Šæ¯é …ç›®æ¼¸å…¥å‹•ç•«
        const messageItems = document.querySelectorAll('.message-item');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '0';
                    entry.target.style.transform = 'translateX(-20px)';
                    
                    setTimeout(() => {
                        entry.target.style.transition = 'all 0.5s ease';
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateX(0)';
                    }, 100);
                    
                    observer.unobserve(entry.target);
                }
            });
        });
        
        messageItems.forEach(item => observer.observe(item));
    }
    
    // æ•¸å­—å‹•ç•«
    function animateNumber(element, start, end, duration) {
        const startTime = performance.now();
        const isFloat = end.toString().includes('.');
        
        function updateNumber(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // ä½¿ç”¨ç·©å‹•å‡½æ•¸
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            const current = start + (end - start) * easeOutQuart;
            
            if (isFloat) {
                element.textContent = current.toFixed(1);
            } else {
                element.textContent = Math.floor(current);
            }
            
            if (progress < 1) {
                requestAnimationFrame(updateNumber);
            } else {
                element.textContent = isFloat ? end.toFixed(1) : end;
            }
        }
        
        requestAnimationFrame(updateNumber);
    }
    
    // é€²åº¦æ¢å‹•ç•«
    function animateProgressBars() {
        const progressBars = document.querySelectorAll('[style*="width:"]');
        progressBars.forEach(bar => {
            const targetWidth = bar.style.width;
            bar.style.width = '0%';
            
            setTimeout(() => {
                bar.style.transition = 'width 1s ease-out';
                bar.style.width = targetWidth;
            }, 500);
        });
    }
    
    // å¹³æ»‘æ»¾å‹•è¨­ç½®
    function setupSmoothScrolling() {
        const scrollLinks = document.querySelectorAll('a[href^="#"]');
        scrollLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    // æ·»åŠ é–ƒçˆæ•ˆæœ
                    target.style.animation = 'none';
                    setTimeout(() => {
                        target.style.animation = 'highlight 2s ease-out';
                    }, 10);
                }
            });
        });
    }
    
    // å·¥å…·æç¤ºåˆå§‹åŒ–
    function initTooltips() {
        const tooltipElements = [
            { selector: '.stat-card', content: 'é»æ“ŠæŸ¥çœ‹è©³ç´°çµ±è¨ˆ' },
            { selector: '.message-question', content: 'é€™æ˜¯ä¸€å€‹å•é¡Œé¡å‹çš„å°è©±' },
            { selector: '.topic-tag', content: 'AIè­˜åˆ¥çš„ä¸»é¡Œæ¨™ç±¤' },
            { selector: '.status-tag', content: 'ç•¶å‰ç‹€æ…‹æŒ‡æ¨™' }
        ];
        
        tooltipElements.forEach(({ selector, content }) => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                if (!el.hasAttribute('title')) {
                    el.setAttribute('title', content);
                }
            });
        });
    }
    
    // è‡ªå‹•åˆ·æ–°è¨­ç½®
    function setupAutoRefresh() {
        // æ¯5åˆ†é˜æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ‘˜è¦
        setInterval(() => {
            const summaryElement = document.querySelector('[style*="667eea"]');
            if (summaryElement) {
                const refreshIndicator = document.createElement('div');
                refreshIndicator.innerHTML = 'ğŸ”„ è³‡æ–™å¯èƒ½å·²æ›´æ–°ï¼Œ<a href="#" onclick="refreshSummary()" style="color: white; text-decoration: underline;">é»æ“Šé‡æ–°æ•´ç†</a>';
                refreshIndicator.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(102, 126, 234, 0.9); color: white; padding: 10px 15px; border-radius: 8px; font-size: 0.9em; z-index: 1000; animation: slideInRight 0.5s ease;';
                
                document.body.appendChild(refreshIndicator);
                
                setTimeout(() => {
                    refreshIndicator.remove();
                }, 10000);
            }
        }, 300000); // 5åˆ†é˜
    }
    
    // é‡æ–°æ•´ç†æ‘˜è¦
    function refreshSummary() {
        const refreshBtn = document.querySelector('button[onclick="refreshSummary()"]');
        if (refreshBtn) {
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span class="loading"></span> åˆ†æä¸­...';
            refreshBtn.disabled = true;
            
            // æ¨¡æ“¬APIå‘¼å«
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }
    }
    
    // è¤‡è£½å­¸ç”Ÿè³‡è¨Š
    function copyStudentInfo() {
        const studentName = '{{ student.name }}';
        const studentId = '{{ student.line_user_id }}';
        const participationRate = '{{ "%.1f"|format(student.participation_rate) }}';
        const messageCount = '{{ learning_summary.message_count }}';
        
        const info = `å­¸ç”Ÿå§“å: ${studentName}
LINE ID: ${studentId}
åƒèˆ‡åº¦: ${participationRate}%
å°è©±æ•¸: ${messageCount}`;
        
        navigator.clipboard.writeText(info).then(() => {
            showNotification('å­¸ç”Ÿè³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
        }).catch(() => {
            showNotification('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–', 'error');
        });
    }
    
    // é€šçŸ¥ç³»çµ±
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
        `;
        
        switch(type) {
            case 'success':
                notification.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
                break;
            case 'error':
                notification.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                break;
            default:
                notification.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // åŒ¯å‡ºç¢ºèª
    function confirmExport() {
        return confirm('ç¢ºå®šè¦åŒ¯å‡º {{ student.name }} çš„å®Œæ•´å­¸ç¿’æª”æ¡ˆå—ï¼Ÿé€™å°‡åŒ…å«æ‰€æœ‰å°è©±è¨˜éŒ„å’Œåˆ†æè³‡æ–™ã€‚');
    }
    
    // éµç›¤å¿«æ·éµ
    document.addEventListener('keydown', function(e) {
        // Ctrl+R æˆ– Cmd+R é‡æ–°æ•´ç†æ‘˜è¦
        if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
            e.preventDefault();
            refreshSummary();
        }
        
        // Ctrl+E æˆ– Cmd+E åŒ¯å‡ºæª”æ¡ˆ
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
            e.preventDefault();
            if (confirmExport()) {
                window.location.href = '/students/{{ student.id }}/export';
            }
        }
        
        // Ctrl+C æˆ– Cmd+C (åœ¨ç©ºç™½è™•) è¤‡è£½å­¸ç”Ÿè³‡è¨Š
        if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !window.getSelection().toString()) {
            copyStudentInfo();
        }
    });
    
    // æ·»åŠ å³éµé¸å–®
    document.addEventListener('contextmenu', function(e) {
        if (e.target.closest('.stat-card') || e.target.closest('.message-item')) {
            e.preventDefault();
            // å¯ä»¥åœ¨é€™è£¡æ·»åŠ è‡ªå®šç¾©å³éµé¸å–®
        }
    });
</script>

<!-- æ·»åŠ CSSå‹•ç•« -->
<style>
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    @keyframes highlight {
        0%, 100% { background-color: transparent; }
        50% { background-color: rgba(52, 152, 219, 0.1); }
    }
</style>
{% endblock %}
