{% extends "base_profile.html" %}

{% block title %}å­¸ç”Ÿåˆ—è¡¨ - EMIæ™ºèƒ½æ•™å­¸åŠ©ç†{% endblock %}

{% block page_title %}ğŸ‘¥ å­¸ç”Ÿåˆ—è¡¨ç®¡ç†{% endblock %}
{% block page_subtitle %}Student Profile Management - å®Œæ•´å­¸ç¿’æ­·ç¨‹è¿½è¹¤{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <a href="/">ğŸ  é¦–é </a>
    <span>â€º</span>
    <a href="/admin">âš™ï¸ ç®¡ç†å¾Œå°</a>
    <span>â€º</span>
    <span>ğŸ‘¥ å­¸ç”Ÿåˆ—è¡¨</span>
</nav>
{% endblock %}

{% block nav_buttons %}
<a href="/" class="btn btn-secondary">ğŸ  é¦–é </a>
<a href="/admin" class="btn btn-primary">âš™ï¸ ç®¡ç†å¾Œå°</a>
<a href="/students/export" class="btn btn-export">ğŸ“Š åŒ¯å‡ºæ¸…å–®</a>
<a href="/health" class="btn btn-secondary">ğŸ¥ ç³»çµ±æª¢æŸ¥</a>
{% endblock %}

{% block stats_section %}
<div class="stats-grid">
    <div class="stat-card blue">
        <h3>{{ total_students }}</h3>
        <p>ğŸ“š ç¸½å­¸ç”Ÿæ•¸</p>
    </div>
    <div class="stat-card green">
        <h3>{{ active_students }}</h3>
        <p>ğŸ”¥ æ´»èºå­¸ç”Ÿ</p>
    </div>
    <div class="stat-card orange">
        <h3>{{ total_messages }}</h3>
        <p>ğŸ’¬ ç¸½å°è©±æ•¸</p>
    </div>
    <div class="stat-card purple">
        <h3>{{ average_participation|round(1) }}%</h3>
        <p>ğŸ“ˆ å¹³å‡åƒèˆ‡åº¦</p>
    </div>
</div>
{% endblock %}

{% block main_content %}
<!-- æœå°‹èˆ‡ç¯©é¸å€åŸŸ -->
<div class="search-container">
    <form method="GET" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <input type="text" 
               name="search" 
               value="{{ search or '' }}" 
               placeholder="ğŸ” æœå°‹å­¸ç”Ÿå§“åã€LINE ID æˆ–å­¸è™Ÿ..." 
               class="search-box"
               style="flex: 1; min-width: 300px;">
        
        <select name="activity" class="search-box" style="width: auto; min-width: 150px;">
            <option value="">å…¨éƒ¨æ´»å‹•ç‹€æ…‹</option>
            <option value="active" {{ 'selected' if activity_filter == 'active' }}>æ´»èºå­¸ç”Ÿ</option>
            <option value="moderate" {{ 'selected' if activity_filter == 'moderate' }}>é©åº¦æ´»å‹•</option>
            <option value="inactive" {{ 'selected' if activity_filter == 'inactive' }}>è¼ƒå°‘æ´»å‹•</option>
        </select>
        
        <select name="sort" class="search-box" style="width: auto; min-width: 150px;">
            <option value="last_active" {{ 'selected' if sort_by == 'last_active' }}>æœ€å¾Œæ´»å‹•æ™‚é–“</option>
            <option value="message_count" {{ 'selected' if sort_by == 'message_count' }}>å°è©±æ•¸é‡</option>
            <option value="participation" {{ 'selected' if sort_by == 'participation' }}>åƒèˆ‡åº¦</option>
            <option value="created_at" {{ 'selected' if sort_by == 'created_at' }}>è¨»å†Šæ™‚é–“</option>
        </select>
        
        <button type="submit" class="btn btn-primary">ğŸ” æœå°‹</button>
        
        {% if search or activity_filter or sort_by != 'last_active' %}
        <a href="/students" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…é™¤ç¯©é¸</a>
        {% endif %}
    </form>
</div>

<!-- å­¸ç”Ÿåˆ—è¡¨ -->
<div class="content-section">
    <h2 class="section-title">
        ğŸ“‹ å­¸ç”Ÿæ¸…å–®
        <span style="font-size: 0.7em; color: #7f8c8d; font-weight: normal;">
            {% if search %}
            æœå°‹ã€Œ{{ search }}ã€çš„çµæœ ({{ student_stats|length }} ä½å­¸ç”Ÿ)
            {% else %}
            å…± {{ student_stats|length }} ä½å­¸ç”Ÿ
            {% endif %}
        </span>
    </h2>

    {% if student_stats %}
    <!-- å­¸ç”Ÿå¡ç‰‡ç¶²æ ¼ -->
    <div class="item-grid">
        {% for item in student_stats %}
        <div class="item-card">
            <!-- å­¸ç”ŸåŸºæœ¬è³‡è¨Š -->
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                    <h3 style="color: #2c3e50; margin-bottom: 5px; font-size: 1.1em;">
                        {{ item.student.name }}
                    </h3>
                    <p style="color: #7f8c8d; font-size: 0.85em; margin-bottom: 3px;">
                        ğŸ“± LINE ID: {{ item.student.line_user_id[:25] }}{% if item.student.line_user_id|length > 25 %}...{% endif %}
                    </p>
                    {% if item.student.student_id %}
                    <p style="color: #7f8c8d; font-size: 0.85em;">
                        ğŸ“ å­¸è™Ÿ: {{ item.student.student_id }}
                    </p>
                    {% endif %}
                </div>
                
                <!-- æ´»å‹•ç‹€æ…‹æ¨™ç±¤ -->
                <span class="status-tag {{ 'status-active' if item.activity_status == 'æ´»èº' else 'status-moderate' if item.activity_status == 'é©åº¦æ´»å‹•' else 'status-inactive' }}">
                    {{ item.activity_status }}
                </span>
            </div>

            <!-- å­¸ç¿’çµ±è¨ˆ -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                <div style="text-align: center; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                    <div style="font-size: 1.3em; font-weight: bold; color: #3498db;">{{ item.message_count }}</div>
                    <div style="font-size: 0.8em; color: #7f8c8d;">ğŸ’¬ å°è©±æ•¸</div>
                </div>
                <div style="text-align: center; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                    <div style="font-size: 1.3em; font-weight: bold; color: #e74c3c;">{{ "%.1f"|format(item.student.participation_rate) }}%</div>
                    <div style="font-size: 0.8em; color: #7f8c8d;">ğŸ“ˆ åƒèˆ‡åº¦</div>
                </div>
            </div>

            <!-- æœ€å¾Œæ´»å‹•æ™‚é–“ -->
            {% if item.last_message_time %}
            <div style="background: #e8f5e8; padding: 8px; border-radius: 6px; margin-bottom: 15px;">
                <div style="font-size: 0.85em; color: #27ae60; display: flex; align-items: center; gap: 8px;">
                    <span>ğŸ•’</span>
                    <span>æœ€å¾Œæ´»å‹•: {{ item.last_message_time.strftime('%mæœˆ%dæ—¥ %H:%M') }}</span>
                </div>
            </div>
            {% else %}
            <div style="background: #fff3cd; padding: 8px; border-radius: 6px; margin-bottom: 15px;">
                <div style="font-size: 0.85em; color: #856404; display: flex; align-items: center; gap: 8px;">
                    <span>â³</span>
                    <span>å°šæœªé–‹å§‹å°è©±</span>
                </div>
            </div>
            {% endif %}

            <!-- å­¸ç¿’ç‰¹å¾µæ¨™ç±¤ -->
            <div style="margin-bottom: 15px;">
                {% if item.student.participation_rate > 80 %}
                <span class="topic-tag" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">é«˜åº¦åƒèˆ‡</span>
                {% elif item.student.participation_rate > 50 %}
                <span class="topic-tag" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">é©åº¦åƒèˆ‡</span>
                {% endif %}

                {% if item.message_count > 20 %}
                <span class="topic-tag" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">æ´»èºè¨è«–</span>
                {% elif item.message_count > 10 %}
                <span class="topic-tag" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">ç©©å®šåƒèˆ‡</span>
                {% endif %}

                {% if item.student.language_preference == 'english' %}
                <span class="topic-tag" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">è‹±æ–‡ä¸»å°</span>
                {% elif item.student.language_preference == 'chinese' %}
                <span class="topic-tag" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">ä¸­æ–‡ä¸»å°</span>
                {% endif %}
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div style="display: flex; gap: 10px;">
                <a href="/students/{{ item.student.id }}" 
                   class="btn btn-primary" 
                   style="flex: 1; text-align: center; font-size: 0.85em;">
                    ğŸ“ æŸ¥çœ‹è©³æƒ…
                </a>
                <a href="/students/{{ item.student.id }}/export" 
                   class="btn btn-export" 
                   style="font-size: 0.85em;">
                    ğŸ’¾ åŒ¯å‡º
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- åˆ†é åŠŸèƒ½ (å¦‚æœéœ€è¦) -->
    {% if total_pages > 1 %}
    <div style="display: flex; justify-content: center; margin-top: 30px; gap: 10px;">
        {% if current_page > 1 %}
        <a href="?page={{ current_page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if activity_filter %}&activity={{ activity_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
           class="btn btn-secondary">â† ä¸Šä¸€é </a>
        {% endif %}
        
        <span style="display: flex; align-items: center; color: #7f8c8d;">
            ç¬¬ {{ current_page }} é ï¼Œå…± {{ total_pages }} é 
        </span>
        
        {% if current_page < total_pages %}
        <a href="?page={{ current_page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if activity_filter %}&activity={{ activity_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
           class="btn btn-secondary">ä¸‹ä¸€é  â†’</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <!-- ç©ºç‹€æ…‹ -->
    <div class="empty-state">
        {% if search %}
        <h3>ğŸ” æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å­¸ç”Ÿ</h3>
        <p>æ²’æœ‰å­¸ç”Ÿç¬¦åˆæœå°‹æ¢ä»¶ã€Œ{{ search }}ã€</p>
        <div style="margin-top: 20px;">
            <a href="/students" class="btn btn-primary">ğŸ—‘ï¸ æ¸…é™¤æœå°‹æ¢ä»¶</a>
        </div>
        {% else %}
        <h3>ğŸ“š é‚„æ²’æœ‰å­¸ç”Ÿè³‡æ–™</h3>
        <p>ç›®å‰ç³»çµ±ä¸­é‚„æ²’æœ‰å­¸ç”Ÿè¨»å†Šä½¿ç”¨ã€‚</p>
        <p style="margin-top: 10px; font-size: 0.9em;">
            å­¸ç”Ÿå¯ä»¥é€é LINE Bot é–‹å§‹å°è©±ä¾†è‡ªå‹•è¨»å†Šåˆ°ç³»çµ±ä¸­ã€‚
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- å¿«é€Ÿæ“ä½œå€åŸŸ -->
<div class="content-section">
    <h2 class="section-title">âš¡ å¿«é€Ÿæ“ä½œ</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <!-- åŒ¯å‡ºåŠŸèƒ½ -->
        <div style="background: #e8f5e8; padding: 20px; border-radius: 8px;">
            <h4 style="color: #27ae60; margin-bottom: 10px;">ğŸ“Š è³‡æ–™åŒ¯å‡º</h4>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                åŒ¯å‡ºæ‰€æœ‰å­¸ç”Ÿçš„åŸºæœ¬è³‡æ–™å’Œçµ±è¨ˆè³‡è¨Š
            </p>
            <a href="/students/export" class="btn btn-success" style="width: 100%;">
                ğŸ“‹ åŒ¯å‡º TSV æ¸…å–®
            </a>
        </div>

        <!-- ç³»çµ±ç‹€æ…‹ -->
        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px;">
            <h4 style="color: #1976d2; margin-bottom: 10px;">ğŸ¥ ç³»çµ±ç‹€æ…‹</h4>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                æª¢æŸ¥ç³»çµ±é‹è¡Œç‹€æ…‹å’Œè³‡æ–™åº«é€£æ¥
            </p>
            <a href="/health" class="btn btn-primary" style="width: 100%;">
                ğŸ”§ ç³»çµ±æª¢æŸ¥
            </a>
        </div>

        <!-- ç®¡ç†åŠŸèƒ½ -->
        <div style="background: #fff3e0; padding: 20px; border-radius: 8px;">
            <h4 style="color: #f57c00; margin-bottom: 10px;">âš™ï¸ ç³»çµ±ç®¡ç†</h4>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                è¨ªå•å®Œæ•´çš„ç®¡ç†å¾Œå°åŠŸèƒ½
            </p>
            <a href="/admin" class="btn btn-export" style="width: 100%;">
                ğŸ› ï¸ ç®¡ç†å¾Œå°
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* å­¸ç”Ÿåˆ—è¡¨å°ˆç”¨æ¨£å¼ */
    .item-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .item-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }

    .item-card:hover::before {
        transform: scaleY(1);
    }

    .item-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    /* æœå°‹æ¡†å‹•ç•« */
    .search-box:focus {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    /* éŸ¿æ‡‰å¼èª¿æ•´ */
    @media (max-width: 768px) {
        .item-grid {
            grid-template-columns: 1fr;
        }
        
        .search-container form {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            min-width: auto !important;
            width: 100% !important;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // å­¸ç”Ÿåˆ—è¡¨å°ˆç”¨JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // å³æ™‚æœå°‹åŠŸèƒ½
        const searchInput = document.querySelector('input[name="search"]');
        let searchTimeout;
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    // å¯ä»¥åœ¨é€™è£¡å¯¦ç¾å³æ™‚æœå°‹
                    console.log('æœå°‹:', this.value);
                }, 300);
            });
        }

        // æ·»åŠ è¼‰å…¥æ•ˆæœåˆ°åŒ¯å‡ºæŒ‰éˆ•
        const exportButtons = document.querySelectorAll('a[href*="/export"]');
        exportButtons.forEach(button => {
            button.addEventListener('click', function() {
                const original = this.innerHTML;
                this.innerHTML = '<span class="loading"></span> åŒ¯å‡ºä¸­...';
                
                // 5ç§’å¾Œæ¢å¾©åŸç‹€ (é˜²æ­¢ä½¿ç”¨è€…é‡è¤‡é»æ“Š)
                setTimeout(() => {
                    this.innerHTML = original;
                }, 5000);
            });
        });

        // çµ±è¨ˆå¡ç‰‡å‹•ç•«
        const statCards = document.querySelectorAll('.stat-card');
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '0';
                    entry.target.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        entry.target.style.transition = 'all 0.6s ease';
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }, Math.random() * 200);
                }
            });
        }, observerOptions);

        statCards.forEach(card => {
            observer.observe(card);
        });

        // å­¸ç”Ÿå¡ç‰‡æ‡¸åœæ•ˆæœå¢å¼·
        const studentCards = document.querySelectorAll('.item-card');
        studentCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.zIndex = '10';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.zIndex = '1';
            });
        });

        // ç¯©é¸å™¨è®Šæ›´æ™‚è‡ªå‹•æäº¤
        const filterSelects = document.querySelectorAll('select[name="activity"], select[name="sort"]');
        filterSelects.forEach(select => {
            select.addEventListener('change', function() {
                // è‡ªå‹•æäº¤è¡¨å–®
                this.closest('form').submit();
            });
        });

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            // Ctrl+K æˆ– Cmd+K èšç„¦æœå°‹æ¡†
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchBox = document.querySelector('.search-box');
                if (searchBox) {
                    searchBox.focus();
                    searchBox.select();
                }
            }
        });

        // é¡¯ç¤ºæœå°‹æç¤º
        const searchBox = document.querySelector('input[name="search"]');
        if (searchBox) {
            searchBox.setAttribute('title', 'æç¤ºï¼šä½¿ç”¨ Ctrl+K å¿«é€Ÿèšç„¦æœå°‹æ¡†');
        }
    });

    // ç¢ºèªåŒ¯å‡ºåŠŸèƒ½
    function confirmExport(type) {
        return confirm(`ç¢ºå®šè¦åŒ¯å‡º${type}å—ï¼Ÿé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ä¾†è™•ç†ã€‚`);
    }

    // æ‰¹é‡æ“ä½œåŠŸèƒ½ (æœªä¾†æ“´å±•ç”¨)
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][name="student_ids"]');
        const selectAll = document.querySelector('#select-all');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateBatchActions();
    }

    function updateBatchActions() {
        const checked = document.querySelectorAll('input[type="checkbox"][name="student_ids"]:checked');
        const batchActions = document.querySelector('.batch-actions');
        
        if (batchActions) {
            batchActions.style.display = checked.length > 0 ? 'block' : 'none';
            
            const countElement = document.querySelector('.selected-count');
            if (countElement) {
                countElement.textContent = checked.length;
            }
        }
    }
</script>
{% endblock %}
